<!DOCTYPE html>
<html>
<head>
	<title>Deep dive into React</title>
	<script src="http://fb.me/react-0.14.7.js"></script>
	<script src="http://fb.me/react-dom-0.14.7.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.23/browser.min.js"></script>
	<style type="text/css">
	.listInput {
		/*width: 25%;*/
	}
	.generatedLists {
		/*display: inline-block;*/
	}
	span {
		/*display: block;*/
	}
	</style>
</head>
<body>
	<div id="app"></div>
	<script type="text/babel">
	var OnChangeMixin = {
		onChange: function(e) {
			this.setState({ text: e.target.value });
		}
	};
	var OnPressingEnterMixin = {
		onPressingEnter: function(e) {
			if (e.keyCode == 13) { this.onClick() };
		}
	};
	var Message = React.createClass({
		render: function() {
			return <span>{this.props.text}</span>;
		}
	});
	var MessageList = React.createClass({
		propTypes: {
			generatedLists: React.PropTypes.any.isRequired
		},

		handleMessageDelete: function(key) {
			this.props.onDeleteMessage(key, this);
		},

		handleMessageArchive: function(key) {
			this.props.onArchiveMessage(key, this);
		},

		onMessageMove: function(msgKey, oldListKey, targetListKey) {
			this.props.onMessageMove(msgKey, oldListKey, targetListKey);
		},

		render: function() {
			var createMessage = function(msg) {
				return (
					<tr key={msg.index} ref="messageFromList">
						<td><Message text={msg.text} /></td>
						<td><GeneratedListDropDown generatedLists={this.props.generatedLists} myListKey={this.props.myListKey} msgKey={msg.index} onMessageMove={this.onMessageMove} /></td>
						<td><input type="button" value="X" onClick={this.handleMessageDelete.bind(this, msg.index)} /></td>
						<td><input type="button" value="Archive" onClick={this.handleMessageArchive.bind(this, msg.index)} /></td>
					</tr>
				);
			}
			return <table><tbody>{this.props.messageList.map(createMessage, this)}</tbody></table>;
		}
	});
	var ArchiveList = React.createClass({
		handleMessageExtract: function(key) {
			this.props.onMessageExtract(key, this);
		},

		render: function() {
			var createMessage = function(msg) {
				return (
					<tr key={msg.index}>
						<td><Message text={msg.text} /></td>
						<td><input type="button" value="Extract" onClick={this.handleMessageExtract.bind(this, msg.index)} /></td>
					</tr>
				);
			};
			return (
				<table>
					<thead><tr><td colSpan="2">{"---Archive---"}</td></tr></thead>
					<tbody>
						{this.props.archivedList.map(createMessage, this)}
					</tbody>
				</table>
			);
		}
	});
	var AssignmentApp = React.createClass({
		mixins: [
			OnChangeMixin,
			OnPressingEnterMixin
		],

		getInitialState: function() {
			return {
				generatedLists: [],
				text: '',
				index: 0
			}
		},

		submitNewList: function() {
			if (this.state.text === '') { return; };
			var listsCopy = this.state.generatedLists.slice();
			var newIndex = this.state.index;
			listsCopy.push({
				name: this.state.text,
				index: this.state.index
			});
			newIndex++;
			this.setState({
				generatedLists: listsCopy,
				text: '',
				index: newIndex
			});
		},

		moveMessage: function(msgKey, oldListKey, targetListKey) {
			// console.log('msg: '+msgKey);
			// console.log('old: '+oldListKey);
			// console.log('trg: '+targetListKey);
			if (oldListKey === 'undefined' || targetListKey === 'undefined' || msgKey === 'undefined') { return; }
			var oldList;
			console.log(this.state.generatedLists);
		},

		onClick: function() { this.submitNewList() },

		render: function() {
			var createLists = function(generatedList) {
				return <GeneratedList key={generatedList.index} myListKey={generatedList.index} data={generatedList} generatedLists={this.state.generatedLists} onMessageMove={this.moveMessage}/>
			};
			return (
				<div>
					<div className="listInput">
						<h4>Add a new list</h4>
						<input onChange={this.onChange} value={this.state.text} onKeyDown={this.onPressingEnter} />
						<input type="button" value="Submit" onClick={this.submitNewList} />
					</div>
					<div>
						{this.state.generatedLists.map(createLists, this)}
					</div>
				</div>
			);
		}
	});
	var GeneratedList = React.createClass({
		mixins: [
			OnChangeMixin,
			OnPressingEnterMixin
		],

		propTypes: {

		},

		getInitialState: function () {
			return {
				text: '',
				messageList: [],
				archivedList: [],
				index: 0
			};
		},

		submitMessage: function() {
			if (this.state.text === '') { return; };
			var allMessages = this.state.messageList.slice();
			if (this.isValidMessage(this.state.text)) {
				allMessages.push({
					text: this.state.text,
					index: this.state.index
				});
				this.setState({
					text: '',
					messageList: allMessages,
					index: this.state.index + 1
				});
			} else {
				//TODO handle error
			}
		},

		deleteMessage: function(key) {
			var findMessage = function(list, index) {
				if (list.index === key) {
					var currentMessages = this.state.messageList.slice();
					currentMessages.splice(index, 1);
					this.setState({	messageList: currentMessages });
				}
			};
			this.state.messageList.forEach(findMessage, this);
		},

		archiveMessage: function(key) {
			var pushMessageToArchive = function(msg, index) {
				if (msg.index === key) {
					var currentMessagesInArchive = this.state.archivedList.slice();
					var currentMessages = this.state.messageList.slice();
					currentMessagesInArchive.push(msg);
					currentMessages.splice(index, 1);
					this.setState({	
						messageList: currentMessages,
						archivedList: currentMessagesInArchive 
					});
				}
			};
			this.state.messageList.forEach(pushMessageToArchive, this);
		},

		extractMessage: function(key) {
			var pushMessageToMessageList = function(msg, index) {
				if (msg.index === key) {
					var currentMessagesInArchive = this.state.archivedList.slice();
					var currentMessages = this.state.messageList.slice();
					currentMessages.push(msg);
					currentMessagesInArchive.splice(index, 1);
					this.setState({	
						messageList: currentMessages,
						archivedList: currentMessagesInArchive 
					});
				}
			};
			this.state.archivedList.forEach(pushMessageToMessageList, this);
		},

		onMessageMove: function(msgKey, oldListKey, targetListKey) {
			this.props.onMessageMove(msgKey, oldListKey, targetListKey);
		},

		onClick: function() { this.submitMessage() },

		isValidMessage: function(msg) {
			if (msg.length <= 200) {
				return true;
			}
			return false;
		},

		render: function() {
			return (
				<div className="generatedLists">
					<h3>{this.props.data.name}</h3>
					<h5>Add new message</h5>
					<input type="text" onChange={this.onChange} value={this.state.text} onKeyDown={this.onPressingEnter} />
					<input type="button" value="add" onClick={this.submitMessage} />
					<MessageList messageList={this.state.messageList} generatedLists={this.props.generatedLists} onDeleteMessage={this.deleteMessage} onArchiveMessage={this.archiveMessage} onMessageMove={this.onMessageMove} myListKey={this.props.myListKey} />
					<ArchiveList archivedList={this.state.archivedList} onMessageExtract={this.extractMessage} />
				</div>
			);
		}
	});
	var GeneratedListDropDown = React.createClass({
		propTypes: {
			generatedLists: React.PropTypes.any.isRequired,
		},

		getInitialState: function() {
			return {
				value: ''
			};
		},

		handleMessageMove: function(msgKey, oldListKey, targetListKey) {
			this.props.onMessageMove(msgKey, oldListKey, targetListKey);
		},

		onChange: function(e) {
			this.handleMessageMove(this.props.msgKey, this.props.myListKey, e.target.value);
		},

		render: function() {
			var createDropdownList = function(list) {
				return <option key={list.index} value={list.index}>{list.name}</option>
			};
			return (
				<select onChange={this.onChange}>
					{this.props.generatedLists.map(createDropdownList, this)}
				</select>
			);
		}
	});
	ReactDOM.render(
		<AssignmentApp />, 
		document.getElementById('app')
	);
	</script>
</body>
</html>
